#!/usr/bin/env bash
set -euo pipefail

# Ensure we are in repo root
cd "$(dirname "$0")/.."

# # Force CPU-only PyTorch wheels on Linux (repo2docker) while keeping PyPI for everything else.
# # This ensures torch resolves from the CPU index, but other packages come from PyPI.
# export PIP_INDEX_URL="https://download.pytorch.org/whl/cpu"
# export PIP_EXTRA_INDEX_URL="https://pypi.org/simple"
# export PIP_PREFER_BINARY=1
# echo "postBuild: PIP_INDEX_URL=$PIP_INDEX_URL"
# echo "postBuild: PIP_EXTRA_INDEX_URL=$PIP_EXTRA_INDEX_URL"

# Do NOT install backend as an editable package here; we rely on PYTHONPATH set in start
# to import backend/docframe/docworkspace from the repo. Runtime deps are installed via environment.yml.
# if [ -d "ldaca_web_app/backend" ]; then
#   pip install -e ldaca_web_app/backend
# fi

# Install local Python libraries into site-packages (non-editable) to bake them into the image
# if [ -f "docframe/pyproject.toml" ]; then
#   python -m pip install ./docframe
# fi
# if [ -f "docworkspace/pyproject.toml" ]; then
#   python -m pip install ./docworkspace
# fi
# python -m pip install ./docframe
# python -m pip install ./docworkspace
# python -m pip install ./ldaca_web_app/backend

# Install local packages (non-editable) using path form to avoid invalid direct-reference syntax.
# We avoid the "name @ ./path" form because pip expects a valid file URL when using '@'.
# Path-based installs ensure correct resolution and extras work reliably.
echo "[postBuild] Verifying local project directories exist"
for p in ./docframe ./ldaca_web_app/docworkspace ./ldaca_web_app/backend; do
  if [ ! -f "$p/pyproject.toml" ]; then
    echo "[postBuild][ERROR] Missing pyproject.toml in $p" >&2
    exit 1
  fi
done

echo "[postBuild] Installing local Python packages (docframe[cpu], docworkspace, backend)"
pip install uv
# Install docframe with its CPU extra first (provides torch CPU wheels) so subsequent builds reuse deps
uv pip install --system "./docframe[cpu]"
uv pip install --system "./ldaca_web_app/docworkspace"
uv pip install --system "./ldaca_web_app/backend"
echo "[postBuild] Local package installation complete"

# Prefetch the Sentence-Transformers model used by BERTopic by default.
# BERTopic defaults to "sentence-transformers/all-MiniLM-L6-v2" when no embedding_model is specified.
# Download into the jovyan cache so runtime does not require network access.
export HF_HOME=${HF_HOME:-/home/jovyan/.cache/huggingface}
export TRANSFORMERS_CACHE=${TRANSFORMERS_CACHE:-$HF_HOME/transformers}
export HF_DATASETS_CACHE=${HF_DATASETS_CACHE:-$HF_HOME/datasets}
export SENTENCE_TRANSFORMERS_HOME=${SENTENCE_TRANSFORMERS_HOME:-$HF_HOME/sentence_transformers}
mkdir -p "$TRANSFORMERS_CACHE" "$HF_DATASETS_CACHE" "$SENTENCE_TRANSFORMERS_HOME"

python - <<'PY'
import os
try:
  from sentence_transformers import SentenceTransformer
except Exception as e:
  print(f"[postBuild] sentence-transformers not available yet: {e}")
else:
  cache = os.environ.get("SENTENCE_TRANSFORMERS_HOME") or None
  print(f"[postBuild] Prefetching 'sentence-transformers/all-MiniLM-L6-v2' -> {cache}")
  SentenceTransformer("sentence-transformers/all-MiniLM-L6-v2", cache_folder=cache)
  print("[postBuild] Model prefetched.")
PY

# Ensure backend .env exists by copying from example if present (non-interactive)
if [ -d "ldaca_web_app/backend" ]; then
  if [ ! -f "ldaca_web_app/backend/.env" ] && [ -f "ldaca_web_app/backend/.env.example" ]; then
    cp "ldaca_web_app/backend/.env.example" "ldaca_web_app/backend/.env"
  fi
fi

# Build frontend if present
if [ -f "ldaca_web_app/frontend/package.json" ]; then
  pushd ldaca_web_app/frontend
  # Use npm ci only when a lockfile exists, else fallback to npm install
  if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ] || [ -f pnpm-lock.yaml ] || [ -f yarn.lock ]; then
    npm ci || npm install
  else
    npm install
  fi
  # Set PUBLIC_URL so CRA emits relative asset URLs (static/js, not /static/js)
  CI=false PUBLIC_URL=. npm run build
  popd
  # Copy build to user-space web dir for nginx
  mkdir -p "$HOME/www"
  cp -r ldaca_web_app/frontend/build/* "$HOME/www/"
else
  mkdir -p "$HOME/www"
  cat > "$HOME/www/index.html" <<'HTML'
<!doctype html>
<html><head><meta charset="utf-8"/><title>LDaCA</title></head>
<body>
<h2>LDaCA Frontend not built</h2>
<p>API docs: <a href="/proxy/3000/api/docs">/proxy/3000/api/docs</a></p>
</body></html>
HTML
fi

# Prepare nginx prefix directories (user-space)
mkdir -p "$HOME/nginx/logs" "$HOME/nginx/run" "$HOME/nginx/tmp" \
         "$HOME/nginx/tmp/client_body" "$HOME/nginx/tmp/proxy_temp" \
         "$HOME/nginx/tmp/fastcgi_temp" "$HOME/nginx/tmp/uwsgi_temp" \
         "$HOME/nginx/tmp/scgi_temp"

# Write a user-space nginx configuration (no root privileges required)
cat > "$HOME/nginx/nginx.conf" <<'NGINX'
worker_processes  1;
error_log  logs/error.log warn;
pid        run/nginx.pid;

events {
  worker_connections  1024;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  # All temp paths under user prefix
  client_body_temp_path tmp/client_body;
  proxy_temp_path       tmp/proxy_temp;
  fastcgi_temp_path     tmp/fastcgi_temp;
  uwsgi_temp_path       tmp/uwsgi_temp;
  scgi_temp_path        tmp/scgi_temp;

  access_log    logs/access.log;
  sendfile        on;
  keepalive_timeout  65;

  server {
    listen 3000;
    server_name _;

    root   www;
    index  index.html index.htm;

    location / {
      try_files $uri $uri/ /index.html;
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      add_header Pragma "no-cache";
      add_header Expires "0";
    }

    location /api/ {
      proxy_pass http://127.0.0.1:8001;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
      add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;

      if ($request_method = 'OPTIONS') {
        return 204;
      }
    }

    location /health {
      access_log off;
      return 200 "healthy\n";
      add_header Content-Type text/plain;
    }
  }
}
NGINX

# Place content under the nginx prefix directory structure used by `nginx -p $HOME/nginx`
mkdir -p "$HOME/nginx/www"
cp -r "$HOME/www"/* "$HOME/nginx/www/" 2>/dev/null || true

# Skip explicit Jupyter extension enabling (not needed and breaks on Jupyter Server v2+)
echo "postBuild: skipping jupyter extension enabling; jupyter-server-proxy will be available if installed."

chmod +x "$PWD/start"
